<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>GeoJSON-OSM-Editor</title>

    <link rel="stylesheet" href="index.css">
    
    <script src="osm-api.js"></script>
    <script src="index.js"></script>
    <script src="config.js"></script>
    <script>
      
      function readFile(file) {
	  return new Promise((resolve, reject) => {
	      const reader = new FileReader();
	      reader.onload = res => { resolve(res.target.result);};
	      reader.onerror = err => reject(err);
	      reader.readAsText(file);
	  });	  
      }
      
      async function onSubmit() {
	  const file = document.getElementById('inputfile').files[0];
	  const contents = await readFile(file);
	  document.getElementById("work").innerHTML="";
	  document.getElementById("proceed").setAttribute("style","display:none");
	  document.getElementById("finish").innerHTML="";
	  document.getElementById("comment").value = '';
	  document.getElementById("upload").setAttribute("style","display:none");
	  
	  checkGeoJSON(contents);
      }

      function show(value){
	   const node = document.createElement("p");
	   node.innerHTML="<pre>"+JSON.stringify(value,null,2)+"</pre>";
	   document.getElementById("work").appendChild(node);

      }

      function log(type, message, element="work"){

	  let prefix;
	  let postfix="";
	  const node = document.createElement("p");

	  switch(type){
	  case 0:
	      node.setAttribute("style","color:green;margin-top:4px;margin-bottom:4px");
	      prefix="&nbsp;&nbsp;&nbsp;Info: ";
	      break;
	  case 1:
	      node.setAttribute("style","color:orange;margin-top:4px;margin-bottom:4px");
	      prefix="Warning: ";
	      break;
	  case 2:
	      node.setAttribute("style","color:red;margin-top:4px;margin-bottom:4px");
	      prefix="&nbsp;&nbsp;Error: ";
	      postfix=" programm aborted."
	      break;
	  default:
	      node.setAttribute("style","color:black;margin-top:4px;margin-bottom:4px");
	      prefix="????";
	      break;
	  }
	  node.innerHTML=prefix+message+postfix;
	  document.getElementById(element).appendChild(node);     
      }
      
      
      function proceed(){
	  let com = document.getElementById("comment").value;
	  if(com==''){
	      document.getElementById("upload").setAttribute("style","display:none");
	  }else{
	      comment=com;
	      //uploadChangeset();
	      document.getElementById("proceed").setAttribute("style","display:none");
	  }
      }

      function abort(){
	  document.getElementById("proceed").setAttribute("style","display:none");
	  log(0,"upload is canceled. program terminates");
      }

      function commentbutton(){
	  let com = document.getElementById("comment").value;
	  let elm;
	  if(com==''){
	      elm=document.getElementById('upload').setAttribute("style","display:none");
	  }else{
	      comment=com;
	      elm=document.getElementById('upload').setAttribute("style","display:inline");
	  }
      }
      
      function selection(){
	  let home=document.getElementById("home");           
	  let server=document.getElementById("server");
	  ans=server.options[server.selectedIndex].text;
	  
	  switch(ans){
	  case 'Sandbox':
	      home.setAttribute("style","background:grey");
	      if(OSM.isLoggedIn())loginout();
	      //sandbox=true;
	      setOptions(true);
	      break;
	  case 'Openstreetmap':
	      home.setAttribute("style","background:red");
	      if(OSM.isLoggedIn())loginout();
	      //sandbox=false;
	      setOptions(false);
	      break;
	  default: console.log(ans)
	      break;
	  }
      }

      function loginout(){  
	  let loginouter= document.getElementById("loginout")  
	  if(OSM.isLoggedIn()){
              OSM.logout();
	      loginouter.innerHTML="Login";
	      document.getElementById("inputfile").setAttribute("style","display:none");
	      document.getElementById("filelabel").setAttribute("style","display:none");
	  }else{
	      OSM.login(options)
		  .then((arg) => {
		      document.getElementById("work").innerHTML="";
		      loginouter.innerHTML="Logout";
		      document.getElementById("inputfile").setAttribute("style","display:inline");
		      document.getElementById("filelabel").setAttribute("style","display:inline");
		  })
		  .catch((arg) => {
		      log(2,"Login to OSM did not work: "+arg); 
		  });    
	  }
      }
      

      function onLoad(){
	  setOptions(true);
	  //document.getElementById('comment').value=comment;
      }
      
    </script>
  </head>

  <body onload="onLoad()"  id="body">
    <h2>GeoJSON-Node-Editor</h2>
    <div class="inputbox" id="home" style="background:grey">
      <label for="server">Server:</label>
      <select onchange="selection()" id="server">
	<option value="sandbox">Sandbox</option>
	<option value="openstreetmap">Openstreetmap</option>
      </select>
      
      <button id="loginout" onclick="loginout()" style="">Login</button>
      &nbsp;
      &nbsp;
      <label id="filelabel" style="display:inline" for="inputfile">Inputfile:</label>
      <input type="file" style="display:inline" onchange="onSubmit(this)" id="inputfile">
    </div>
    
    <div id="work" style="background:white"></div>
    
    <div class="inputbox" id="proceed" style="display:none">
      <label id="commentlabel" style="display:inline" for="comment">Comment:</label>
      <input placeholder="your upload comment" type="text" maxsize="50" style="display:inline" id="comment">
      <button onclick="commentbutton()">set</button>
      <span id="upload" style="display:none">
	&nbsp;&nbsp;&nbsp;Do you want to proceed?&nbsp;&nbsp;
	<button onclick="proceed()" style="margin:4px">yes</button>&nbsp;
	<button onclick="abort()" style="margin:4px">no</button>
      </span>
    </div>
    
    <div class="inputbox" id="finish" style="background:lightgreen"></div>    
  </body>
</html>
